#!/bin/bash
echo "Starting blocknetdx-qt"

which blocknetdx-qt

# Fast sync mode
if [[ ! -v BLOCKNETDX_SNAPSHOT ]]
then
  echo "Normal startup"
  echo $BLOCKNETDX_SNAPSHOT
else
  echo "Check fastsync startup?"
  if [ ! -f "$BLOCKNETDX_DATA/.fast_synced" ]
  then
    echo "Extracting snapshot from zip: $BLOCKNETDX_SNAPSHOT to: $BLOCKNETDX_DATA"
    unzip -d $BLOCKNETDX_DATA $BLOCKNETDX_SNAPSHOT
    mv $BLOCKNETDX_DATA/BlocknetDX/blocks $BLOCKNETDX_DATA/blocks
    mv $BLOCKNETDX_DATA/BlocknetDX/chainstate $BLOCKNETDX_DATA/chainstate
    touch $BLOCKNETDX_DATA/.fast_synced
  fi
fi

cat <<-EOF > "$BLOCKNETDX_DATA/blocknetdx.conf"
datadir=/home/blocknet/.blocknetdx
dbcache=256
maxmempool=512
maxmempoolxbridge=128
${BLOCKNETDX_EXTRA_ARGS}
EOF

# Set some defaults
if [[ ! -v BLOCKNETDX_EXTRA_ARGS ]]
then
  echo "Setting defaults"
  cat << EOF >> "$BLOCKNETDX_DATA/blocknetdx.conf"
port=41412
rpcport=41414
listen=1
server=1
wallet=1
logtimestamps=1
logips=1
rpcallowip=0.0.0.0/0
rpctimeout=15
rpcclienttimeout=15
printtoconsole=1
rpcuser=$BLOCKNETDX_RPC_USER
rpcpassword=$BLOCKNETDX_RPC_PASSWORD
EOF
fi

cat <<-EOF > "$BLOCKNETDX_DATA/xbridge.conf"
[Main]
ExchangeWallets=BLOCK,BTC
FullLog=true
LogPath=
ExchangeTax=300

[BLOCK]
Title=Blocknet
Ip=127.0.0.1
Port=41414
AddressPrefix=26
ScriptPrefix=28
SecretPrefix=154
COIN=100000000
MinimumAmount=0
TxVersion=1
DustAmount=0
CreateTxMethod=BTC
GetNewKeySupported=true
ImportWithNoScanSupported=true
MinTxFee=10000
BlockTime=60
FeePerByte=20
Confirmations=0
Username=$BLOCKNETDX_RPC_USER
Password=$BLOCKNETDX_RPC_PASSWORD
Address=

[BTC]
Title=Bitcoin
Address=
Ip=$BITCOIN_ADDRESS
Port=$BITCOIN_PORT
Username=$BITCOIN_RPC_USER
Password=$BITCOIN_RPC_PASSWORD
AddressPrefix=0
ScriptPrefix=5
SecretPrefix=128
COIN=100000000
MinimumAmount=0
TxVersion=2
DustAmount=0
CreateTxMethod=BTC
MinTxFee=0
BlockTime=600
GetNewKeySupported=false
ImportWithNoScanSupported=false
FeePerByte=30
Confirmations=0
EOF

chown -R blocknet:blocknet $BLOCKNETDX_DATA

exec gosu blocknet blocknetdx-qt --conf=/home/blocknet/.blocknetdx/blocknetdx.conf